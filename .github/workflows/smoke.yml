name: Smoke Tests

on:
  push:
    branches:
      - "**"
  pull_request:
    branches:
      - "**"

jobs:
  smoke-tests:
    name: Smoke Tests
    runs-on: ubuntu-latest

    steps:
      - name: Check out Git repository
        uses: actions/checkout@v3
  
      - name: Use Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 16.x
          cache: 'npm'

      - name: Install Node.js dependencies
        run: |
          npm install

      # JavaScript Generator
      - name: Check out the openapi-forge-javascript generator
        uses: actions/checkout@v3
        with: 
          repository: ScottLogic/openapi-forge-javascript
          path: openapi-forge-javascript

      - name: Install openapi-forge-javascript dependencies
        run: |
          cd openapi-forge-javascript
          npm install

      - name: Return to the main folder
        run: |
          cd ..

      - name: Make script executable
        run: |
          chmod +x ./src/index.js

      - id: generator_options
        name: Test Generator Options Command
        run: |
          echo "generator-options<<EOF" >> $GITHUB_OUTPUT
          echo "$(./src/index.js generator-options openapi-forge-javascript)" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Print generator-options command STDOUT
        run: echo "${{ steps.generator_options.outputs.generator-options }}"

      - name: Check Output of Generator Options 1
        if: ${{ contains(steps.generator_options.outputs.generator-options, 'moduleFormat') }}
        run: |
          echo "generator-options command succeeded!"

      - name: Check Output of Generator Options 2
        if: ${{ !contains(steps.generator_options.outputs.generator-options, 'moduleFormat') }}
        run: |
          echo "expected generator-options command to produce the moduleFormat option for the JavaScript generator"
          exit 1

      # TypeScript Generator
      - name: Go to the top level
        run: |
          cd ..
          ls

      - name: Check out the openapi-forge-typescript generator
        uses: actions/checkout@v3
        with: 
          repository: ScottLogic/openapi-forge-typescript
          path: openapi-forge-typescript

      - name: Install openapi-forge-typescript dependencies
        run: |
          cd openapi-forge-typescript
          npm install

      - name: Return to the main folder
        run: |
          cd ../openapi-forge/
          ls

      - id: test_generators
        name: Test Generator Options Command
        run: |
          echo "test-generators<<EOF" >> $GITHUB_OUTPUT
          echo "$(./src/index.js test-generators --generators openapi-forge-typescript --format 'json' --logLevel 'quiet')" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Print test-generators command STDOUT
        run: echo "${{ steps.test_generators.outputs.test-generators }}"

      - name: Check Output of Test Generators 1
        if: ${{ fromJson(steps.test_generators.outputs.test-generators).scenarios > 0 && fromJson(steps.generator_options.outputs.test-generators).scenarios == fromJson(steps.generator_options.outputs.test-generators).passed }}
        run: |
          echo "test-generators command succeeded!"

      - name: Check Output of Test Generators 2
        if: ${{ fromJson(steps.test_generators.outputs.test-generators).scenarios > 0 && fromJson(steps.generator_options.outputs.test-generators).scenarios == fromJson(steps.generator_options.outputs.test-generators).passed }}
        run: |
          echo "expected test-generators command to show that all tests for the TypeScript generator are passing"
          exit 1